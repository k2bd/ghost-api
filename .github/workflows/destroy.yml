name: Destroy stale deployments

on: [delete]

jobs:
  destroy:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - uses: nelonoel/branch-name@v1.0.1
    - name: install python
      uses: actions/setup-python@v2
      with:
        python-version: '3.8'
    - name: Use Node.js 12.x
      uses: actions/setup-node@v1
      with:
        node-version: 12.x
    - name: Use Poetry
      uses: abatilo/actions-poetry@v2.0.0
      with:
        poetry-version: 1.1.4
    - name: Prepare serverless
      run: |
        echo Installing Serverless
        npm i serverless -g
        npm i serverless-python-requirements
    - name: Remove deployment
      run:
        echo Removing deployment ${BRANCH_NAME}
        sls config credentials --provider aws --key ${AWS_ACCESS_KEY_ID} --secret ${AWS_SECRET_ACCESS_KEY}
        serverless remove --stage ${BRANCH_NAME}
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.DEPLOY_ACCESS_KEY }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.DEPLOY_SECRET_KEY }}
  